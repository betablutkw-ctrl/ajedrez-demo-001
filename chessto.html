<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Ajedrez — Turnos Arreglados</title>

<style>
    body { 
        font-family: sans-serif; 
        display: flex; 
        gap: 20px; 
        padding: 20px;
    }

    #boardWrapper {
        display: grid;
        grid-template-columns: 20px repeat(8, 60px);
        grid-template-rows: 20px repeat(8, 60px);
    }

    .coord {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 16px;
        user-select: none;
        font-weight: bold;
    }

    #board { 
        display: grid;
        grid-template-columns: repeat(8, 60px);
        grid-column: 2 / span 8;
        grid-row: 2 / span 8;
    }

    .cell {
        width: 60px; height: 60px;
        display: flex; justify-content: center; align-items: center;
        font-size: 40px; cursor: pointer;
        transition: 0.15s;
        user-select: none;
    }

    .white { background: #eee; }
    .black { background: #555; }

    .highlight { background: #bff2c2 !important; }
    #selectedCell { outline: 3px solid #00aa44; }

    #rightPanel {
        width: 320px;
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    #turnIndicator {
        font-size: 20px;
        font-weight: bold;
    }

    #log {
        width: 100%; height: 350px;
        border: 1px solid #aaa;
        overflow-y: auto;
        padding: 10px;
        background: #fafafa;
    }

    #fenInput {
        width: 100%;
        font-size: 14px;
        padding: 5px;
    }
</style>

</head>
<body>

<div id="boardWrapper">

    <div class="coord"></div>
    <div class="coord">A</div>
    <div class="coord">B</div>
    <div class="coord">C</div>
    <div class="coord">D</div>
    <div class="coord">E</div>
    <div class="coord">F</div>
    <div class="coord">G</div>
    <div class="coord">H</div>

    <div id="board"></div>

    <div class="coord" style="grid-row:2; grid-column:1;">8</div>
    <div class="coord" style="grid-row:3; grid-column:1;">7</div>
    <div class="coord" style="grid-row:4; grid-column:1;">6</div>
    <div class="coord" style="grid-row:5; grid-column:1;">5</div>
    <div class="coord" style="grid-row:6; grid-column:1;">4</div>
    <div class="coord" style="grid-row:7; grid-column:1;">3</div>
    <div class="coord" style="grid-row:8; grid-column:1;">2</div>
    <div class="coord" style="grid-row:9; grid-column:1;">1</div>

</div>

<div id="rightPanel">

    <!-- INDICADOR DE TURNO -->
    <div id="turnIndicator">Turno:</div>

    <!-- FEN -->
    <h3>Estado FEN</h3>
    <textarea id="fenInput" rows="3"></textarea>

    <div style="display:flex;gap:8px;">
        <button onclick="copyFEN()">Copiar</button>
        <button onclick="loadFEN()">Cargar</button>
    </div>

    <h3>Registro</h3>
    <div id="log"></div>

</div>

<script>
// =============================================
//                TABLERO INICIAL
// =============================================
let board = [
    ["r","n","b","q","k","b","n","r"],
    ["p","p","p","p","p","p","p","p"],
    ["","","","","","","",""],
    ["","","","","","","",""],
    ["","","","","","","",""],
    ["","","","","","","",""],
    ["P","P","P","P","P","P","P","P"],
    ["R","N","B","Q","K","B","N","R"]
];

let selected = null;
let validMoves = [];

let firstMove = true;      
let whiteToMove = true;    

const boardElement = document.getElementById("board");
const fenInput = document.getElementById("fenInput");
const logEl = document.getElementById("log");
const turnIndicator = document.getElementById("turnIndicator");

// =============================================
//         PIEZAS UNICODE
// =============================================
const PIECE = {
    "P": "♙", "R": "♖", "N": "♘", "B": "♗", "Q": "♕", "K": "♔",
    "p": "♟", "r": "♜", "n": "♞", "b": "♝", "q": "♛", "k": "♚"
};

// =============================================
//         DIBUJAR TABLERO
// =============================================
function updateTurnIndicator() {
    if (firstMove) {
        turnIndicator.textContent = "Turno:";
        return;
    }
    turnIndicator.textContent = "Turno: " + (whiteToMove ? "Blancas" : "Negras");
}

function drawBoard() {
    boardElement.innerHTML = "";

    for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {

            const cell = document.createElement("div");
            cell.className = "cell " + ((r+c)%2===0 ? "white" : "black");

            if (validMoves.some(m => m.r === r && m.c === c)) {
                cell.classList.add("highlight");
            }

            if (selected && selected.r === r && selected.c === c) {
                cell.id = "selectedCell";
            }

            cell.dataset.r = r;
            cell.dataset.c = c;

            cell.textContent = PIECE[board[r][c]] || "";
            cell.onclick = () => handleClick(r, c);

            boardElement.appendChild(cell);
        }
    }

    updateFEN();
    updateTurnIndicator();
}

// =============================================
//               LOG
// =============================================
function logMove(t) {
    logEl.innerHTML += t + "<br>";
    logEl.scrollTop = logEl.scrollHeight;
}

// =============================================
//        CLICK EN CELDA (CORREGIDO)
// =============================================
function handleClick(r, c) {
    const p = board[r][c];

    // ======================================================
    //     SI YA HAY UNA PIEZA SELECCIONADA
    // ======================================================
    if (selected) {

        const isMove = validMoves.some(m => m.r === r && m.c === c);

        // --- 1) Movimiento válido (incluye captura) ---
        if (isMove) {

            const movedPiece = board[selected.r][selected.c];

            logMove(`✔ ${movedPiece} ${selected.r},${selected.c} → ${r},${c}`);

            board[r][c] = movedPiece;
            board[selected.r][selected.c] = "";

            // -------- TURNO 1: determinar quién movió --------
            if (firstMove) {
                if (isWhite(movedPiece)) whiteToMove = false;
                else whiteToMove = true;
                firstMove = false;
            } 
            else {
                // alternancia normal
                whiteToMove = !whiteToMove;
            }

            selected = null;
            validMoves = [];
            drawBoard();
            return;
        }

        // --- 2) Si clicas otra pieza TUYA, cambiar selección ---
        if (p !== "" && isWhite(p) === whiteToMove) {
            selected = { r, c };
            validMoves = getValidMoves(r, c);
            drawBoard();
            return;
        }

        // --- 3) Movimiento ilegal ---
        logMove("❌ Movimiento inválido");
        selected = null;
        validMoves = [];
        drawBoard();
        return;
    }

    // ======================================================
    //        SI NO HAY NADA SELECCIONADO TODAVÍA
    // ======================================================
    if (!firstMove) {
        if (p === "") return;
        if (isWhite(p) !== whiteToMove) {
            alert("No es tu turno");
            return;
        }
    } else {
        if (p === "") return;
    }

    selected = { r, c };
    validMoves = getValidMoves(r, c);
    drawBoard();
}

// =============================================
//       GENERADOR DE MOVIMIENTOS
// =============================================
function getValidMoves(sr, sc) {
    const moves = [];
    for (let r = 0; r < 8; r++)
        for (let c = 0; c < 8; c++)
            if (validMove(sr, sc, r, c)) moves.push({ r, c });
    return moves;
}

// =============================================
//         REGLAS BÁSICAS DE MOVIMIENTO
// =============================================
function isWhite(p) { return typeof p === "string" && p >= "A" && p <= "Z"; }
function isBlack(p) { return typeof p === "string" && p >= "a" && p <= "z"; }

function validMove(sr, sc, tr, tc) {
    const p = board[sr][sc];
    const t = board[tr][tc];
    const dr = tr - sr, dc = tc - sc;

    if (!p) return false;
    if (sr === tr && sc === tc) return false;
    if (isWhite(p) && isWhite(t)) return false;
    if (isBlack(p) && isBlack(t)) return false;

    // Peones:
    if (p === "P") {
        if (dr === -1 && dc === 0 && t === "") return true;
        if (sr === 6 && dr === -2 && dc === 0 && t === "" && board[5][sc] === "") return true;
        if (dr === -1 && Math.abs(dc) === 1 && isBlack(t)) return true;
        return false;
    }

    if (p === "p") {
        if (dr === 1 && dc === 0 && t === "") return true;
        if (sr === 1 && dr === 2 && dc === 0 && t === "" && board[2][sc] === "") return true;
        if (dr === 1 && Math.abs(dc) === 1 && isWhite(t)) return true;
        return false;
    }

    // Caballo
    if (p.toLowerCase() === "n") {
        return (Math.abs(dr) === 1 && Math.abs(dc) === 2) ||
               (Math.abs(dr) === 2 && Math.abs(dc) === 1);
    }

    // Rey
    if (p.toLowerCase() === "k") {
        return Math.abs(dr) <= 1 && Math.abs(dc) <= 1;
    }

    // Alfil
    if (p.toLowerCase() === "b") {
        if (Math.abs(dr) !== Math.abs(dc)) return false;
        return pathClear(sr, sc, tr, tc);
    }

    // Torre
    if (p.toLowerCase() === "r") {
        if (dr !== 0 && dc !== 0) return false;
        return pathClear(sr, sc, tr, tc);
    }

    // Dama
    if (p.toLowerCase() === "q") {
        if (dr === 0 || dc === 0 || Math.abs(dr) === Math.abs(dc))
            return pathClear(sr, sc, tr, tc);
        return false;
    }

    return false;
}

function pathClear(sr, sc, tr, tc) {
    let rStep = Math.sign(tr - sr);
    let cStep = Math.sign(tc - sc);
    let r = sr + rStep, c = sc + cStep;

    while (r !== tr || c !== tc) {
        if (board[r][c] !== "") return false;
        r += rStep;
        c += cStep;
    }
    return true;
}

// =============================================
//                FEN
// =============================================
function updateFEN() {
    let fen = "";
    for (let r=0; r<8; r++) {
        let empty = 0;
        for (let c=0; c<8; c++) {
            if (board[r][c] === "") empty++;
            else {
                if (empty > 0) { fen += empty; empty = 0; }
                fen += board[r][c];
            }
        }
        if (empty > 0) fen += empty;
        if (r < 7) fen += "/";
    }

    if (!firstMove)
        fen += whiteToMove ? " w" : " b";
    else
        fen += " -";

    fenInput.value = fen;
}

function loadFEN() {
    const fen = fenInput.value.trim();
    if (!fen) return;

    const [pos, turn] = fen.split(" ");
    const rows = pos.split("/");
    if (rows.length !== 8) { alert("FEN inválida"); return; }

    for (let r=0; r<8; r++) {
        const row = rows[r];
        let newRow = [];

        for (let char of row) {
            if (!isNaN(char)) {
                for (let i=0; i<Number(char); i++) newRow.push("");
            } else {
                newRow.push(char);
            }
        }

        while (newRow.length < 8) newRow.push("");
        board[r] = newRow;
    }

    if (turn === "w") whiteToMove = true;
    else if (turn === "b") whiteToMove = false;
    else firstMove = true;

    selected = null;
    validMoves = [];
    drawBoard();
}

function copyFEN() {
    fenInput.select();
    document.execCommand("copy");
}

drawBoard();
</script>

</body>
</html>
